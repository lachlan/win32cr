require "../foundation.cr"
require "../system/com.cr"

{% if compare_versions(Crystal::VERSION, "1.8.2") <= 0 %}
@[Link("delayimp")]
{% end %}
@[Link("user32")]
{% if compare_versions(Crystal::VERSION, "1.8.2") <= 0 %}
@[Link(ldflags: "/IGNORE:4199")]
{% end %}
{% if compare_versions(Crystal::VERSION, "1.8.2") <= 0 %}
@[Link(ldflags: "/DELAYLOAD:amsi.dll")]
{% else %}
@[Link("amsi")]
{% end %}
lib LibWin32
  alias HAMSICONTEXT = LibC::IntPtrT
  alias HAMSISESSION = LibC::IntPtrT

  CLSID_CAntimalware = LibC::GUID.new(0xfdb00e52_u32, 0xa214_u16, 0x4aa1_u16, StaticArray[0x8f_u8, 0xba_u8, 0x43_u8, 0x57_u8, 0xbb_u8, 0x0_u8, 0x72_u8, 0xec_u8])


  enum AMSI_RESULT : Int32
    AMSI_RESULT_CLEAN = 0
    AMSI_RESULT_NOT_DETECTED = 1
    AMSI_RESULT_BLOCKED_BY_ADMIN_START = 16384
    AMSI_RESULT_BLOCKED_BY_ADMIN_END = 20479
    AMSI_RESULT_DETECTED = 32768
  end

  enum AMSI_ATTRIBUTE : Int32
    AMSI_ATTRIBUTE_APP_NAME = 0
    AMSI_ATTRIBUTE_CONTENT_NAME = 1
    AMSI_ATTRIBUTE_CONTENT_SIZE = 2
    AMSI_ATTRIBUTE_CONTENT_ADDRESS = 3
    AMSI_ATTRIBUTE_SESSION = 4
    AMSI_ATTRIBUTE_REDIRECT_CHAIN_SIZE = 5
    AMSI_ATTRIBUTE_REDIRECT_CHAIN_ADDRESS = 6
    AMSI_ATTRIBUTE_ALL_SIZE = 7
    AMSI_ATTRIBUTE_ALL_ADDRESS = 8
    AMSI_ATTRIBUTE_QUIET = 9
  end

  enum AMSI_UAC_REQUEST_TYPE : Int32
    AMSI_UAC_REQUEST_TYPE_EXE = 0
    AMSI_UAC_REQUEST_TYPE_COM = 1
    AMSI_UAC_REQUEST_TYPE_MSI = 2
    AMSI_UAC_REQUEST_TYPE_AX = 3
    AMSI_UAC_REQUEST_TYPE_PACKAGED_APP = 4
    AMSI_UAC_REQUEST_TYPE_MAX = 5
  end

  enum AMSI_UAC_TRUST_STATE : Int32
    AMSI_UAC_TRUST_STATE_TRUSTED = 0
    AMSI_UAC_TRUST_STATE_UNTRUSTED = 1
    AMSI_UAC_TRUST_STATE_BLOCKED = 2
    AMSI_UAC_TRUST_STATE_MAX = 3
  end

  enum AMSI_UAC_MSI_ACTION : Int32
    AMSI_UAC_MSI_ACTION_INSTALL = 0
    AMSI_UAC_MSI_ACTION_UNINSTALL = 1
    AMSI_UAC_MSI_ACTION_UPDATE = 2
    AMSI_UAC_MSI_ACTION_MAINTENANCE = 3
    AMSI_UAC_MSI_ACTION_MAX = 4
  end

  union AMSI_UAC_REQUEST_CONTEXT_RequestType_e__Union
    exe_info : AMSI_UAC_REQUEST_EXE_INFO
    com_info : AMSI_UAC_REQUEST_COM_INFO
    msi_info : AMSI_UAC_REQUEST_MSI_INFO
    active_x_info : AMSI_UAC_REQUEST_AX_INFO
    packaged_app_info : AMSI_UAC_REQUEST_PACKAGED_APP_INFO
  end

  struct AMSI_UAC_REQUEST_EXE_INFO
    ul_length : UInt32
    lpwsz_application_name : LibC::LPWSTR
    lpwsz_command_line : LibC::LPWSTR
    lpwsz_dll_parameter : LibC::LPWSTR
  end
  struct AMSI_UAC_REQUEST_COM_INFO
    ul_length : UInt32
    lpwsz_server_binary : LibC::LPWSTR
    lpwsz_requestor : LibC::LPWSTR
    clsid : Guid
  end
  struct AMSI_UAC_REQUEST_MSI_INFO
    ul_length : UInt32
    msi_action : AMSI_UAC_MSI_ACTION
    lpwsz_product_name : LibC::LPWSTR
    lpwsz_version : LibC::LPWSTR
    lpwsz_language : LibC::LPWSTR
    lpwsz_manufacturer : LibC::LPWSTR
    lpwsz_package_path : LibC::LPWSTR
    lpwsz_package_source : LibC::LPWSTR
    ul_updates : UInt32
    ppwsz_updates : LibC::LPWSTR*
    ppwsz_update_sources : LibC::LPWSTR*
  end
  struct AMSI_UAC_REQUEST_AX_INFO
    ul_length : UInt32
    lpwsz_local_install_path : LibC::LPWSTR
    lpwsz_source_url : LibC::LPWSTR
  end
  struct AMSI_UAC_REQUEST_PACKAGED_APP_INFO
    ul_length : UInt32
    lpwsz_application_name : LibC::LPWSTR
    lpwsz_command_line : LibC::LPWSTR
    lp_package_family_name : LibC::LPWSTR
    lp_application_id : LibC::LPWSTR
  end
  struct AMSI_UAC_REQUEST_CONTEXT
    ul_length : UInt32
    ul_requestor_process_id : UInt32
    uac_trust_state : AMSI_UAC_TRUST_STATE
    type : AMSI_UAC_REQUEST_TYPE
    request_type : AMSI_UAC_REQUEST_CONTEXT_RequestType_e__Union
    b_auto_elevate_request : LibC::BOOL
  end


  struct IAmsiStreamVTbl
    query_interface : Proc(IAmsiStream*, Guid*, Void**, HRESULT)
    add_ref : Proc(IAmsiStream*, UInt32)
    release : Proc(IAmsiStream*, UInt32)
    get_attribute : Proc(IAmsiStream*, AMSI_ATTRIBUTE, UInt32, UInt8*, UInt32*, HRESULT)
    read : Proc(IAmsiStream*, UInt64, UInt32, UInt8*, UInt32*, HRESULT)
  end

  IAmsiStream_GUID = "3e47f2e5-81d4-4d3b-897f-545096770373"
  IID_IAmsiStream = LibC::GUID.new(0x3e47f2e5_u32, 0x81d4_u16, 0x4d3b_u16, StaticArray[0x89_u8, 0x7f_u8, 0x54_u8, 0x50_u8, 0x96_u8, 0x77_u8, 0x3_u8, 0x73_u8])
  struct IAmsiStream
    lpVtbl : IAmsiStreamVTbl*
  end

  struct IAntimalwareProviderVTbl
    query_interface : Proc(IAntimalwareProvider*, Guid*, Void**, HRESULT)
    add_ref : Proc(IAntimalwareProvider*, UInt32)
    release : Proc(IAntimalwareProvider*, UInt32)
    scan : Proc(IAntimalwareProvider*, IAmsiStream, AMSI_RESULT*, HRESULT)
    close_session : Proc(IAntimalwareProvider*, UInt64, Void)
    display_name : Proc(IAntimalwareProvider*, LibC::LPWSTR*, HRESULT)
  end

  IAntimalwareProvider_GUID = "b2cabfe3-fe04-42b1-a5df-08d483d4d125"
  IID_IAntimalwareProvider = LibC::GUID.new(0xb2cabfe3_u32, 0xfe04_u16, 0x42b1_u16, StaticArray[0xa5_u8, 0xdf_u8, 0x8_u8, 0xd4_u8, 0x83_u8, 0xd4_u8, 0xd1_u8, 0x25_u8])
  struct IAntimalwareProvider
    lpVtbl : IAntimalwareProviderVTbl*
  end

  struct IAntimalwareUacProviderVTbl
    query_interface : Proc(IAntimalwareUacProvider*, Guid*, Void**, HRESULT)
    add_ref : Proc(IAntimalwareUacProvider*, UInt32)
    release : Proc(IAntimalwareUacProvider*, UInt32)
    uac_scan : Proc(IAntimalwareUacProvider*, AMSI_UAC_REQUEST_CONTEXT*, AMSI_RESULT*, HRESULT)
    display_name : Proc(IAntimalwareUacProvider*, LibC::LPWSTR*, HRESULT)
  end

  IAntimalwareUacProvider_GUID = "b2cabfe4-fe04-42b1-a5df-08d483d4d125"
  IID_IAntimalwareUacProvider = LibC::GUID.new(0xb2cabfe4_u32, 0xfe04_u16, 0x42b1_u16, StaticArray[0xa5_u8, 0xdf_u8, 0x8_u8, 0xd4_u8, 0x83_u8, 0xd4_u8, 0xd1_u8, 0x25_u8])
  struct IAntimalwareUacProvider
    lpVtbl : IAntimalwareUacProviderVTbl*
  end

  struct IAntimalwareProvider2VTbl
    query_interface : Proc(IAntimalwareProvider2*, Guid*, Void**, HRESULT)
    add_ref : Proc(IAntimalwareProvider2*, UInt32)
    release : Proc(IAntimalwareProvider2*, UInt32)
    scan : Proc(IAntimalwareProvider2*, IAmsiStream, AMSI_RESULT*, HRESULT)
    close_session : Proc(IAntimalwareProvider2*, UInt64, Void)
    display_name : Proc(IAntimalwareProvider2*, LibC::LPWSTR*, HRESULT)
    notify : Proc(IAntimalwareProvider2*, Void*, UInt32, LibC::LPWSTR, LibC::LPWSTR, AMSI_RESULT*, HRESULT)
  end

  IAntimalwareProvider2_GUID = "7c1e6570-3f73-4e0f-8ad4-98b94cd3290f"
  IID_IAntimalwareProvider2 = LibC::GUID.new(0x7c1e6570_u32, 0x3f73_u16, 0x4e0f_u16, StaticArray[0x8a_u8, 0xd4_u8, 0x98_u8, 0xb9_u8, 0x4c_u8, 0xd3_u8, 0x29_u8, 0xf_u8])
  struct IAntimalwareProvider2
    lpVtbl : IAntimalwareProvider2VTbl*
  end

  struct IAntimalwareVTbl
    query_interface : Proc(IAntimalware*, Guid*, Void**, HRESULT)
    add_ref : Proc(IAntimalware*, UInt32)
    release : Proc(IAntimalware*, UInt32)
    scan : Proc(IAntimalware*, IAmsiStream, AMSI_RESULT*, IAntimalwareProvider*, HRESULT)
    close_session : Proc(IAntimalware*, UInt64, Void)
  end

  IAntimalware_GUID = "82d29c2e-f062-44e6-b5c9-3d9a2f24a2df"
  IID_IAntimalware = LibC::GUID.new(0x82d29c2e_u32, 0xf062_u16, 0x44e6_u16, StaticArray[0xb5_u8, 0xc9_u8, 0x3d_u8, 0x9a_u8, 0x2f_u8, 0x24_u8, 0xa2_u8, 0xdf_u8])
  struct IAntimalware
    lpVtbl : IAntimalwareVTbl*
  end

  struct IAntimalware2VTbl
    query_interface : Proc(IAntimalware2*, Guid*, Void**, HRESULT)
    add_ref : Proc(IAntimalware2*, UInt32)
    release : Proc(IAntimalware2*, UInt32)
    scan : Proc(IAntimalware2*, IAmsiStream, AMSI_RESULT*, IAntimalwareProvider*, HRESULT)
    close_session : Proc(IAntimalware2*, UInt64, Void)
    notify : Proc(IAntimalware2*, Void*, UInt32, LibC::LPWSTR, LibC::LPWSTR, AMSI_RESULT*, HRESULT)
  end

  IAntimalware2_GUID = "301035b5-2d42-4f56-8c65-2dcaa7fb3cdc"
  IID_IAntimalware2 = LibC::GUID.new(0x301035b5_u32, 0x2d42_u16, 0x4f56_u16, StaticArray[0x8c_u8, 0x65_u8, 0x2d_u8, 0xca_u8, 0xa7_u8, 0xfb_u8, 0x3c_u8, 0xdc_u8])
  struct IAntimalware2
    lpVtbl : IAntimalware2VTbl*
  end


  # Params # appname : LibC::LPWSTR [In],amsicontext : HAMSICONTEXT* [In]
  fun AmsiInitialize(appname : LibC::LPWSTR, amsicontext : HAMSICONTEXT*) : HRESULT

  # Params # amsicontext : HAMSICONTEXT [In]
  fun AmsiUninitialize(amsicontext : HAMSICONTEXT)

  # Params # amsicontext : HAMSICONTEXT [In],amsisession : HAMSISESSION* [In]
  fun AmsiOpenSession(amsicontext : HAMSICONTEXT, amsisession : HAMSISESSION*) : HRESULT

  # Params # amsicontext : HAMSICONTEXT [In],amsisession : HAMSISESSION [In]
  fun AmsiCloseSession(amsicontext : HAMSICONTEXT, amsisession : HAMSISESSION)

  # Params # amsicontext : HAMSICONTEXT [In],buffer : Void* [In],length : UInt32 [In],contentname : LibC::LPWSTR [In],amsisession : HAMSISESSION [In],result : AMSI_RESULT* [In]
  fun AmsiScanBuffer(amsicontext : HAMSICONTEXT, buffer : Void*, length : UInt32, contentname : LibC::LPWSTR, amsisession : HAMSISESSION, result : AMSI_RESULT*) : HRESULT

  # Params # amsicontext : HAMSICONTEXT [In],buffer : Void* [In],length : UInt32 [In],contentname : LibC::LPWSTR [In],result : AMSI_RESULT* [In]
  fun AmsiNotifyOperation(amsicontext : HAMSICONTEXT, buffer : Void*, length : UInt32, contentname : LibC::LPWSTR, result : AMSI_RESULT*) : HRESULT

  # Params # amsicontext : HAMSICONTEXT [In],string : LibC::LPWSTR [In],contentname : LibC::LPWSTR [In],amsisession : HAMSISESSION [In],result : AMSI_RESULT* [In]
  fun AmsiScanString(amsicontext : HAMSICONTEXT, string : LibC::LPWSTR, contentname : LibC::LPWSTR, amsisession : HAMSISESSION, result : AMSI_RESULT*) : HRESULT

  # Params # elamfile : LibC::HANDLE [In]
  fun InstallELAMCertificateInfo(elamfile : LibC::HANDLE) : LibC::BOOL
end